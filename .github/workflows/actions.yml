name: linux-kernel
on: [push]

env:
  builder: rikonor/linux-kernel-builder:09fd4986210e51efa3805c267ddda00e7c17d4c6
  upstream: AMDESE/linux
  ref: 93e2466caee94edb1616ab75f48983ecbc86a03b

jobs:
  linux-kernel:
    runs-on: ubuntu-latest
    steps:
      - name: Clone self
        uses: actions/checkout@v4
        with:
          path: ${{ github.workspace }}/local

      - name: Clone upstream
        uses: actions/checkout@v4
        with:
          repository: ${{ env.upstream }}
          ref: ${{ env.ref }}
          path: ${{ github.workspace }}/upstream

      - name: Login to container registry
        run: |
          docker login \
            -u ${{ secrets.CONTAINER_REGISTRY_USERNAME }} \
            -p ${{ secrets.CONTAINER_REGISTRY_PASSWORD }} \
            ghcr.io

      - name: Build upstream
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/local:/local \
            -v ${{ github.workspace }}/upstream:/upstream -w /upstream \
            -e CONFIG_PATH="/local/.config" \
            -e LOCALVERSION="-snp-$(echo ${{ env.ref }} | cut -c -7)" \
            ghcr.io/${{ env.builder }} \
              bash /local/build.sh

      - name: Publish
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.RELEASE_ACCESS_TOKEN }}
          tag_name: ${{ env.upstream }}-${{ env.ref }}
          body: |
            | Name | Value |
            | ------------- | ------------- |
            | Builder | `ghcro.io/${{ env.builder }}` |
            | Upstream | [`${{ env.upstream }}:${{ env.ref }}`](https://github.com/${{ env.upstream }}/tree/${{ env.ref }}) |
